# Connection State Recovery (é€£ç·šç‹€æ…‹æ¢å¾©)

## Table of Contents

- [ä»€éº¼æ˜¯ Connection State Recoveryï¼Ÿ](#ä»€éº¼æ˜¯-connection-state-recovery)
- [æ ¸å¿ƒæ¦‚å¿µ](#æ ¸å¿ƒæ¦‚å¿µ)
  - [1. Socket.IO å…§å»ºçš„ Connection State Recovery](#1-socketio-å…§å»ºçš„-connection-state-recovery)
  - [2. å…©ç¨®ç‹€æ…‹åŒæ­¥ç­–ç•¥](#2-å…©ç¨®ç‹€æ…‹åŒæ­¥ç­–ç•¥)
  - [3. åç§»é‡ (Offset) æ©Ÿåˆ¶](#3-åç§»é‡-offset-æ©Ÿåˆ¶)
- [ä¼ºæœå™¨ç«¯å¯¦ä½œåˆ†æ](#ä¼ºæœå™¨ç«¯å¯¦ä½œåˆ†æ)
  - [é€£ç·šç‹€æ…‹æª¢æŸ¥](#é€£ç·šç‹€æ…‹æª¢æŸ¥)
  - [è¨Šæ¯é‡è¤‡é˜²è­·æ©Ÿåˆ¶](#è¨Šæ¯é‡è¤‡é˜²è­·æ©Ÿåˆ¶)
- [å®¢æˆ¶ç«¯å¯¦ä½œåˆ†æ](#å®¢æˆ¶ç«¯å¯¦ä½œåˆ†æ)
  - [é€£ç·šè¨­å®š](#é€£ç·šè¨­å®š)
  - [è¨Šæ¯ç™¼é€èˆ‡ç¢ºèª](#è¨Šæ¯ç™¼é€èˆ‡ç¢ºèª)
  - [ç‹€æ…‹æ›´æ–°](#ç‹€æ…‹æ›´æ–°)
- [é›™å±¤æ¢å¾©æ©Ÿåˆ¶](#é›™å±¤æ¢å¾©æ©Ÿåˆ¶)
- [å®Œæ•´æµç¨‹åœ–](#å®Œæ•´æµç¨‹åœ–)
- [ä¸‰ç¨®è¨Šæ¯å‚³éä¿è­‰](#ä¸‰ç¨®è¨Šæ¯å‚³éä¿è­‰)
  - [1. At Most Once (æœ€å¤šä¸€æ¬¡) - é è¨­è¡Œç‚º](#1-at-most-once-æœ€å¤šä¸€æ¬¡---é è¨­è¡Œç‚º)
  - [2. At Least Once (è‡³å°‘ä¸€æ¬¡)](#2-at-least-once-è‡³å°‘ä¸€æ¬¡)
  - [3. Exactly Once (æ°å¥½ä¸€æ¬¡) - æˆ‘å€‘çš„å¯¦ä½œ](#3-exactly-once-æ°å¥½ä¸€æ¬¡---æˆ‘å€‘çš„å¯¦ä½œ)
- [æ¸¬è©¦æ–·ç·šé‡é€£](#æ¸¬è©¦æ–·ç·šé‡é€£)
  - [ç€è¦½å™¨æ¨¡æ“¬](#ç€è¦½å™¨æ¨¡æ“¬)
  - [ç¨‹å¼ç¢¼æ¸¬è©¦](#ç¨‹å¼ç¢¼æ¸¬è©¦)
- [é—œéµæŠ€è¡“ç´°ç¯€](#é—œéµæŠ€è¡“ç´°ç¯€)
  - [1. è³‡æ–™åº«è¨­è¨ˆ](#1-è³‡æ–™åº«è¨­è¨ˆ)
  - [2. éŒ¯èª¤è™•ç†](#2-éŒ¯èª¤è™•ç†)
  - [3. è¨˜æ†¶é«”å„ªåŒ–](#3-è¨˜æ†¶é«”å„ªåŒ–)
- [å¯¦éš›æ‡‰ç”¨è€ƒé‡](#å¯¦éš›æ‡‰ç”¨è€ƒé‡)
  - [å„ªé»](#å„ªé»)
  - [é™åˆ¶](#é™åˆ¶)
  - [æœ€ä½³å¯¦è¸](#æœ€ä½³å¯¦è¸)
- [åƒè€ƒè³‡æ–™](#åƒè€ƒè³‡æ–™)

## ä»€éº¼æ˜¯ Connection State Recoveryï¼Ÿ

Connection State Recovery æ˜¯ Socket.IO 4.x æ–°å¢çš„åŠŸèƒ½ï¼Œç›®çš„æ˜¯åœ¨å®¢æˆ¶ç«¯çŸ­æš«æ–·ç·šå¾Œé‡æ–°é€£ç·šæ™‚ï¼Œèƒ½å¤ è‡ªå‹•æ¢å¾©ä¹‹å‰çš„é€£ç·šç‹€æ…‹ä¸¦è£œç™¼éŒ¯éçš„è¨Šæ¯ã€‚

## æ ¸å¿ƒæ¦‚å¿µ

### 1. Socket.IO å…§å»ºçš„ Connection State Recovery

åœ¨æ·±å…¥æ¢è¨æ‰‹å‹•å¯¦ä½œä¹‹å‰ï¼Œå…ˆäº†è§£ Socket.IO 4.x æä¾›çš„å…§å»º Connection State Recovery åŠŸèƒ½ã€‚

#### å•Ÿç”¨æ–¹å¼

```javascript
const io = new Server(server, {
  connectionStateRecovery: {},
});
```

#### é‹ä½œåŸç†

æ ¹æ“š [Socket.IO å®˜æ–¹æ•™å­¸](https://socket.io/docs/v4/tutorial/step-6)ï¼Œé€™å€‹åŠŸèƒ½æœƒï¼š

- **æš«æ™‚å„²å­˜** ä¼ºæœå™¨ç™¼é€çš„æ‰€æœ‰äº‹ä»¶
- **å˜—è©¦æ¢å¾©** å®¢æˆ¶ç«¯é‡é€£æ™‚çš„ç‹€æ…‹ï¼š
  - æ¢å¾©å®¢æˆ¶ç«¯çš„æˆ¿é–“ (rooms)
  - ç™¼é€ä»»ä½•éŒ¯éçš„äº‹ä»¶

#### æª¢æŸ¥æ¢å¾©ç‹€æ…‹

```javascript
io.on("connection", async (socket) => {
  socket.emit(
    "system:announcement",
    `*Connected (recovered: ${socket.recovered})`
  );

  if (!socket.recovered) {
    // å…§å»ºæ¢å¾©å¤±æ•—ï¼Œéœ€è¦æ‰‹å‹•è™•ç†
    // å¾è³‡æ–™åº«è£œç™¼éŒ¯éçš„è¨Šæ¯
  }
});
```

#### ç‚ºä»€éº¼ä¸æ˜¯é è¨­å•Ÿç”¨ï¼Ÿ

Socket.IO å®˜æ–¹æ–‡ä»¶æåˆ°å¹¾å€‹åŸå› ï¼š

1. **ä¸ç¸½æ˜¯æœ‰æ•ˆ** - å¦‚æœä¼ºæœå™¨çªç„¶å´©æ½°æˆ–é‡å•Ÿï¼Œå®¢æˆ¶ç«¯ç‹€æ…‹å¯èƒ½ç„¡æ³•ä¿å­˜
2. **æ“´å±•é™åˆ¶** - åœ¨æ°´å¹³æ“´å±• (scaling up) æ™‚ä¸ç¸½æ˜¯å¯èƒ½å•Ÿç”¨æ­¤åŠŸèƒ½
3. **è¨˜æ†¶é«”è€ƒé‡** - éœ€è¦åœ¨è¨˜æ†¶é«”ä¸­æš«å­˜äº‹ä»¶è³‡æ–™

> ğŸ’¡ **æœ€ä½³å¯¦è¸**: å…§å»ºçš„ Connection State Recovery é©åˆè™•ç†çŸ­æš«çš„ç¶²è·¯ä¸­æ–·ï¼ˆå¦‚ WiFi åˆ‡æ›åˆ° 4Gï¼‰ï¼Œä½†å°æ–¼æ›´å¯é çš„è¨Šæ¯å‚³éï¼Œå»ºè­°æ­é…è³‡æ–™åº«æŒä¹…åŒ–çš„æ–¹æ¡ˆã€‚

### 2. å…©ç¨®ç‹€æ…‹åŒæ­¥ç­–ç•¥

æ ¹æ“š Socket.IO [å®˜æ–¹æ–‡ä»¶](https://socket.io/docs/v4/tutorial/step-7)ï¼Œæœ‰å…©ç¨®å¸¸è¦‹çš„ç‹€æ…‹åŒæ­¥æ–¹å¼ï¼š

1. **ä¼ºæœå™¨ç™¼é€å®Œæ•´ç‹€æ…‹** - é‡é€£æ™‚ç™¼é€æ‰€æœ‰è³‡æ–™
2. **å®¢æˆ¶ç«¯è¿½è¹¤åç§»é‡** - å®¢æˆ¶ç«¯è¨˜éŒ„æœ€å¾Œè™•ç†çš„äº‹ä»¶ï¼Œä¼ºæœå™¨åªç™¼é€ç¼ºå¤±çš„éƒ¨åˆ†

æˆ‘å€‘çš„å¯¦ä½œæ¡ç”¨ç¬¬äºŒç¨®æ–¹å¼ï¼Œæ›´æœ‰æ•ˆç‡ã€‚

### 3. åç§»é‡ (Offset) æ©Ÿåˆ¶

- **Server Offset**: ä¼ºæœå™¨ç«¯è¨Šæ¯çš„å”¯ä¸€ ID (è³‡æ–™åº«è‡ªå‹•éå¢çš„ä¸»éµ)
- **Client Offset**: å®¢æˆ¶ç«¯ç”Ÿæˆçš„å”¯ä¸€è­˜åˆ¥ç¬¦ï¼Œç”¨æ–¼é˜²æ­¢é‡è¤‡è¨Šæ¯

## ä¼ºæœå™¨ç«¯å¯¦ä½œåˆ†æ

### é€£ç·šç‹€æ…‹æª¢æŸ¥

```javascript
if (!socket.recovered) {
  // é€£ç·šç‹€æ…‹ç„¡æ³•è‡ªå‹•æ¢å¾©ï¼Œéœ€è¦æ‰‹å‹•è£œç™¼è¨Šæ¯
  try {
    await db.each(
      "SELECT id, content FROM messages WHERE id > ?",
      [socket.handshake.auth.serverOffset || 0],
      (_err, row) => {
        socket.emit("chat:message", row.content, row.id);
      }
    );
  } catch (error) {
    console.error("Error fetching messages: ", error);
  }
}
```

**åŸç†è§£æï¼š**

- `socket.recovered`: Socket.IO è‡ªå‹•è¨­å®šçš„å±¬æ€§
  - `true`: è‡ªå‹•æ¢å¾©æˆåŠŸï¼ŒSocket.IO å·²è™•ç†éŒ¯éçš„è¨Šæ¯
  - `false`: è‡ªå‹•æ¢å¾©å¤±æ•—ï¼Œéœ€è¦æ‰‹å‹•è£œç™¼è¨Šæ¯
- `socket.handshake.auth.serverOffset`: å®¢æˆ¶ç«¯å‚³ä¾†çš„æœ€å¾Œæ”¶åˆ°è¨Šæ¯ ID
- `db.each()`: é€ç­†è™•ç†æŸ¥è©¢çµæœï¼Œé¿å…å¤§é‡è³‡æ–™è¼‰å…¥è¨˜æ†¶é«”

### è¨Šæ¯é‡è¤‡é˜²è­·æ©Ÿåˆ¶

```javascript
socket.on("chat:message", async (msg, clientOffset, callback) => {
  try {
    result = await db.run(
      "INSERT INTO messages (content, client_offset) VALUES (?, ?)",
      msg,
      clientOffset
    );
  } catch (error) {
    if (error.errno === 19) {
      // SQLITE_CONSTRAINT
      // è¨Šæ¯å·²å­˜åœ¨ï¼Œé€šçŸ¥å®¢æˆ¶ç«¯å·²è™•ç†
      callback();
    }
    return;
  }

  io.emit("chat:message", msg, result.lastID);
  callback(); // é‡è¦ï¼šå¿…é ˆç¢ºèªè¨Šæ¯å·²è™•ç†
});
```

**é˜²é‡è¤‡æ©Ÿåˆ¶ï¼š**

- è³‡æ–™åº« `client_offset` æ¬„ä½è¨­ç‚º `UNIQUE`
- é‡è¤‡è¨Šæ¯æœƒè§¸ç™¼ `SQLITE_CONSTRAINT` éŒ¯èª¤ (errno: 19)
- å³ä½¿æ˜¯é‡è¤‡è¨Šæ¯ä¹Ÿè¦å‘¼å« `callback()` é€šçŸ¥å®¢æˆ¶ç«¯

## å®¢æˆ¶ç«¯å¯¦ä½œåˆ†æ

### é€£ç·šè¨­å®š

```javascript
const socket = io({
  auth: {
    serverOffset: 0, // è¿½è¹¤æœ€å¾Œæ”¶åˆ°çš„è¨Šæ¯ ID
  },
  ackTimeout: 10000, // ç­‰å¾…ç¢ºèªä¼ºæœå™¨å›æ‡‰çš„æ™‚é–“
  retries: 3, // é‡è©¦æ¬¡æ•¸
});
```

### è¨Šæ¯ç™¼é€èˆ‡ç¢ºèª

```javascript
form.addEventListener("submit", (e) => {
  if (input.value) {
    const clientOffset = `${socket.id}-${counter++}`;

    socket.emit("chat:message", input.value, clientOffset, (response) => {
      console.log("è¨Šæ¯å·²æˆåŠŸé€é” serverï¼š", response);
    });
  }
});
```

**å®¢æˆ¶ç«¯åç§»é‡ç”Ÿæˆï¼š**

- `socket.id`: 20 å­—å…ƒéš¨æ©Ÿè­˜åˆ¥ç¬¦ï¼Œæ¯æ¬¡é€£ç·šéƒ½ä¸åŒ
- `counter++`: éå¢è¨ˆæ•¸å™¨ï¼Œç¢ºä¿åŒä¸€é€£ç·šå…§çš„å”¯ä¸€æ€§
- çµ„åˆæ ¼å¼ï¼š`"socketId-counter"`

### ç‹€æ…‹æ›´æ–°

```javascript
socket.on("chat:message", (msg, serverOffset) => {
  // é¡¯ç¤ºè¨Šæ¯
  const item = document.createElement("li");
  item.textContent = msg;
  messages.appendChild(item);

  // æ›´æ–°æœ€å¾Œæ”¶åˆ°çš„è¨Šæ¯ ID
  socket.auth.serverOffset = serverOffset;
});
```

## é›™å±¤æ¢å¾©æ©Ÿåˆ¶

é€™å€‹å¯¦ä½œçµåˆäº† Socket.IO å…§å»ºåŠŸèƒ½å’Œæ‰‹å‹•è³‡æ–™åº«æ¢å¾©ï¼Œå½¢æˆé›™å±¤ä¿è­·ï¼š

### ç¬¬ä¸€å±¤ï¼šSocket.IO å…§å»ºæ¢å¾©

- è™•ç†çŸ­æš«çš„ç¶²è·¯ä¸­æ–·
- å¾è¨˜æ†¶é«”ä¸­æ¢å¾©æš«å­˜çš„äº‹ä»¶
- é€Ÿåº¦å¿«ï¼Œä½†æœ‰é™åˆ¶

### ç¬¬äºŒå±¤ï¼šè³‡æ–™åº«æ‰‹å‹•æ¢å¾©

- è™•ç†ä¼ºæœå™¨é‡å•Ÿæˆ–é•·æ™‚é–“æ–·ç·š
- å¾æŒä¹…åŒ–å„²å­˜ä¸­æ¢å¾©è¨Šæ¯
- æ›´å¯é ï¼Œä½†ç¨æ…¢

## å®Œæ•´æµç¨‹åœ–

```
å®¢æˆ¶ç«¯é€£ç·š â†’ ä¼ºæœå™¨æª¢æŸ¥ socket.recovered
    â†“
recovered = true           recovered = false
    â†“                           â†“
Socket.IO è‡ªå‹•æ¢å¾©        æ‰‹å‹•æŸ¥è©¢è³‡æ–™åº«è£œç™¼è¨Šæ¯
(å¾è¨˜æ†¶é«”æ¢å¾©äº‹ä»¶)         (å¾ SQLite æ¢å¾©è¨Šæ¯)
    â†“                           â†“
æ¢å¾©å®Œæˆ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ è£œç™¼å®Œæˆ
```

## ä¸‰ç¨®è¨Šæ¯å‚³éä¿è­‰

### 1. At Most Once (æœ€å¤šä¸€æ¬¡) - é è¨­è¡Œç‚º

- ç‰¹é»ï¼šå¯èƒ½éºå¤±è¨Šæ¯ï¼Œä½†ä¸æœƒé‡è¤‡
- é©ç”¨ï¼šå°è¨Šæ¯å®Œæ•´æ€§è¦æ±‚ä¸é«˜çš„å ´æ™¯

### 2. At Least Once (è‡³å°‘ä¸€æ¬¡)

```javascript
// æ–¹æ³•ä¸€ï¼šæ‰‹å‹•é‡è©¦
function emit(socket, event, arg) {
  socket.timeout(5000).emit(event, arg, (err) => {
    if (err) {
      emit(socket, event, arg); // é‡è©¦
    }
  });
}

// æ–¹æ³•äºŒï¼šä½¿ç”¨ retries é¸é …
const socket = io({
  ackTimeout: 10000,
  retries: 3,
});
```

### 3. Exactly Once (æ°å¥½ä¸€æ¬¡) - æˆ‘å€‘çš„å¯¦ä½œ

- çµåˆé‡è©¦æ©Ÿåˆ¶ + å”¯ä¸€è­˜åˆ¥ç¬¦
- é˜²æ­¢è¨Šæ¯éºå¤±å’Œé‡è¤‡
- é©ç”¨ï¼šå°è¨Šæ¯å®Œæ•´æ€§è¦æ±‚é«˜çš„å ´æ™¯

## æ¸¬è©¦æ–·ç·šé‡é€£

### ç€è¦½å™¨æ¨¡æ“¬

1. é–‹å•Ÿ DevTools â†’ Network åˆ†é 
2. å‹¾é¸ "Offline" æ¨¡æ“¬æ–·ç¶²
3. ç­‰å¹¾ç§’å¾Œå–æ¶ˆå‹¾é¸
4. è§€å¯Ÿæ§åˆ¶å°é¡¯ç¤º `recovered: true/false`

### ç¨‹å¼ç¢¼æ¸¬è©¦

ç¨‹å¼ç¢¼ä¸­æœ‰åŒ…å«äº†æ‰‹å‹•æ–·ç·šé‡é€£çš„æ¸¬è©¦æŒ‰éˆ•ï¼š

```javascript
// æ‰‹å‹•æ–·ç·šé‡é€£æŒ‰éˆ•
disconnectButton.addEventListener("click", (e) => {
  e.preventDefault();

  if (socket.connected) {
    disconnectButton.textContent = "Connect";
    socket.disconnect();
  } else {
    disconnectButton.textContent = "Disconnect";
    socket.connect();
  }
});
```

**æ¸¬è©¦æ­¥é©Ÿ**ï¼š

1. ç™¼é€ä¸€äº›è¨Šæ¯
2. é»æ“Š "Disconnect" æŒ‰éˆ•
3. åœ¨å…¶ä»–ç€è¦½å™¨è¦–çª—ç™¼é€è¨Šæ¯
4. é»æ“Š "Connect" æŒ‰éˆ•é‡æ–°é€£ç·š
5. è§€å¯Ÿæ˜¯å¦æ”¶åˆ°éŒ¯éçš„è¨Šæ¯å’Œ `recovered` ç‹€æ…‹

## é—œéµæŠ€è¡“ç´°ç¯€

### 1. è³‡æ–™åº«è¨­è¨ˆ

```sql
CREATE TABLE IF NOT EXISTS messages (
  id INTEGER PRIMARY KEY AUTOINCREMENT,  -- ä¼ºæœå™¨åç§»é‡
  client_offset TEXT UNIQUE,             -- å®¢æˆ¶ç«¯åç§»é‡ï¼ˆé˜²é‡è¤‡ï¼‰
  content TEXT                           -- è¨Šæ¯å…§å®¹
);
```

### 2. éŒ¯èª¤è™•ç†

- **ç¶²è·¯éŒ¯èª¤**: è‡ªå‹•é‡è©¦æ©Ÿåˆ¶
- **è³‡æ–™åº«éŒ¯èª¤**: æ ¹æ“šéŒ¯èª¤é¡å‹æ±ºå®šæ˜¯å¦é‡è©¦
- **é‡è¤‡è¨Šæ¯**: UNIQUE ç´„æŸé˜²è­·

### 3. è¨˜æ†¶é«”å„ªåŒ–

- ä½¿ç”¨ `db.each()` è€Œé `db.all()` é¿å…å¤§é‡è³‡æ–™è¼‰å…¥
- å®¢æˆ¶ç«¯åªè¿½è¹¤å¿…è¦çš„åç§»é‡è³‡è¨Š

## å¯¦éš›æ‡‰ç”¨è€ƒé‡

### å„ªé»

- è‡ªå‹•è™•ç†çŸ­æš«æ–·ç·š
- ç¢ºä¿è¨Šæ¯å®Œæ•´æ€§
- é˜²æ­¢è¨Šæ¯é‡è¤‡
- ç”¨æˆ¶é«”é©—ä½³

### é™åˆ¶

- éœ€è¦æŒä¹…åŒ–å„²å­˜
- å¢åŠ ä¼ºæœå™¨è¤‡é›œåº¦
- ä¸é©åˆå¤§é‡æ­·å²è¨Šæ¯çš„å ´æ™¯

### æœ€ä½³å¯¦è¸

- å®šæœŸæ¸…ç†èˆŠè¨Šæ¯é¿å…è³‡æ–™åº«éå¤§
- è¨­å®šåˆç†çš„é‡è©¦æ¬¡æ•¸å’Œè¶…æ™‚æ™‚é–“
- ç›£æ§éŒ¯èª¤æ—¥èªŒä»¥å„ªåŒ–ç©©å®šæ€§

## åƒè€ƒè³‡æ–™

- [Socket.IO Tutorial Step 6: Connection state recovery](https://socket.io/docs/v4/tutorial/step-6)
- [Socket.IO Tutorial Step 7: Server delivery](https://socket.io/docs/v4/tutorial/step-7)
- [Socket.IO Tutorial Step 8: Client delivery](https://socket.io/docs/v4/tutorial/step-8)
